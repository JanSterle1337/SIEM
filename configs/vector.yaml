data_dir: "/var/lib/vector"

sources:
  log_generator:
    type: "file"
    include: ["/var/log/siem/raw_ingest.log"]
    read_from: "beginning"

transforms:
  route_logs:
    type: "route"
    inputs: ["log_generator"]
    route:
      ssh: 'contains(string!(.message), "sshd")'
      web: 'contains(string!(.message), "GET")'

  ocsf_auth_transform:
    type: "remap"
    inputs: ["route_logs.ssh"]
    source: |
      # Manual regex for SSH is safer for custom hostnames
      # Matches: ... from <ip> port ...
      parsed = parse_regex(.message, r'from (?P<src_ip>[\d\.]+) port') ?? {}
      
      .category_uid = 3002
      .class_uid = 300201
      .status = if contains(string!(.message), "Accepted") { "Success" } else { "Failure" }
      .disposition_id = if .status == "Success" { 1 } else { 2 }
      
      # Extract user
      user_match = parse_regex(.message, r'for (?P<user>\S+) from') ?? {}
      .user = { "name": user_match.user }
      
      # Map IP correctly to OCSF src_endpoint
      .src_endpoint = { "ip": parsed.src_ip }
      .metadata = { "product": { "name": "Linux SSH" } }

  ocsf_network_transform:
    type: "remap"
    inputs: ["route_logs.web"]
    source: |
      # parse_common_log expects the standard Apache/Nginx format
      parsed, err = parse_common_log(.message)
      if err == null {
          . = parsed
          .category_uid = 4001
          .class_uid = 400102
          .src_endpoint = { "ip": .client_ip }
          .http_request = { "method": .method, "url": { "path": .path } }
          .metadata = { "product": { "name": "Nginx" } }
          del(.client_ip)
      } else {
          # Fallback: simple regex for the IP if the full parser fails
          ip_match = parse_regex(.message, r'^(?P<ip>[\d\.]+)') ?? {}
          .src_endpoint = { "ip": ip_match.ip }
      }

sinks:
  debug_console:
    type: "console"
    inputs: ["ocsf_auth_transform", "ocsf_network_transform"]
    encoding:
      codec: "json"

  redpanda_out:
    type: "kafka"
    inputs: ["ocsf_auth_transform", "ocsf_network_transform"]
    bootstrap_servers: "redpanda:9092"
    topic: "ocsf-events"
    encoding:
      codec: "json"